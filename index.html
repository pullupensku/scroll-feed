<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>SCROLL ‚Äî Feed Vid√©os</title>
<style>
  :root { --maxw: 440px; }
  * { box-sizing: border-box; }
  body { margin: 0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  header { position: sticky; top: 0; background: #000; padding: 12px 16px; border-bottom: 1px solid #111; z-index: 10; }
  header h1 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: .2px; }
  #status { font-size: 12px; color:#9aa; margin-top: 4px; }
  main { display: flex; flex-direction: column; align-items: center; padding: 12px; gap: 16px; }
  .card { width: 100%; max-width: var(--maxw); background: #050505; border: 1px solid #111; border-radius: 12px; overflow: hidden; }
  .meta { padding: 10px 12px; }
  .title { font-size: 14px; font-weight: 600; margin: 0 0 6px; color:#fff; }
  .desc { font-size: 13px; color:#cfd3d7; margin: 0; }
  iframe { width: 100%; aspect-ratio: 9 / 16; border: 0; display: block; background: #000; }
  button.refresh { position: fixed; right: 12px; bottom: 12px; border:1px solid #222; background:#0a0a0a; color:#fff; padding:8px 10px; border-radius:10px; font-size:13px; }
  .hint { font-size: 12px; color:#9aa; text-align: center; }
</style>
</head>
<body>
  <header>
    <h1>SCROLL ‚Äî Flux</h1>
    <div id="status">Chargement‚Ä¶</div>
  </header>

  <main id="feed">
    <p class="hint">Le flux se met √† jour depuis ta Google Sheet (CSV live).</p>
  </main>

  <button class="refresh" id="manualRefresh">Rafra√Æchir</button>

<script>
/** üîó 1) Remplace par ton URL CSV publi√©e depuis Google Sheets */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfUAL6YCQ9iaAduwCP8UInGxkjCZw7KpQ1AUU7guml9XWqf9F3sg7SYsaEgN0vFdwJvWYMC63rgHt9/pub?gid=459772149&single=true&output=csv";

/** ‚öôÔ∏è R√©glages simples */
const AUTO_REFRESH_MS = 30000; // auto-refresh toutes les 30 s (mets 0 pour d√©sactiver)
const YT_PARAMS = "autoplay=0&mute=1&modestbranding=1&rel=0&playsinline=1";

/** Utilitaires */
const $ = s => document.querySelector(s);
const statusEl = $("#status");
const feedEl = $("#feed");
let lastDataHash = "";

/** Petit parseur CSV compatible guillemets (Google Sheets) */
function parseCSV(text) {
  const rows = [];
  let i = 0, cur = "", row = [], inQuotes = false;

  while (i < text.length) {
    const char = text[i];

    if (char === '"') {
      if (inQuotes && text[i+1] === '"') { // √©chappement ""
        cur += '"';
        i += 2;
        continue;
      }
      inQuotes = !inQuotes;
      i++;
      continue;
    }

    if (!inQuotes && (char === ',' || char === '\n' || char === '\r')) {
      row.push(cur);
      cur = "";
      // fin de ligne
      if (char === '\n' || char === '\r') {
        if (row.some(v => v !== "")) rows.push(row);
        row = [];
      }
      i++;
      continue;
    }

    cur += char;
    i++;
  }
  // flush final
  if (cur.length || row.length) {
    row.push(cur);
    if (row.some(v => v !== "")) rows.push(row);
  }
  return rows;
}

/** Convertit un tableau CSV ‚Üí objets avec noms de colonnes */
function csvToObjects(csvRows) {
  if (!csvRows.length) return [];
  const header = csvRows[0].map(h => (h || "").trim());
  const rows = csvRows.slice(1);
  return rows.map(r => {
    const obj = {};
    header.forEach((h, idx) => { obj[h] = (r[idx] || "").trim(); });
    return obj;
  }).filter(Boolean);
}

/** Mapping tol√©rant : supporte "Titre" (majuscule) et "titre" */
function normalizeRow(obj) {
  const titre = obj.Titre ?? obj.titre ?? "";
  const url = obj.url ?? obj.URL ?? "";
  const type = (obj.type ?? obj.Type ?? "").toLowerCase();
  const ordreRaw = obj.ordre ?? obj.Ordre ?? "";
  const ordre = ordreRaw === "" ? null : Number(ordreRaw);
  const description = obj.description ?? obj.Description ?? "";
  return { titre, url, type, ordre, description };
}

/** Extraction d'ID YouTube robuste (watch, youtu.be, shorts, embed) */
function extractYouTubeId(url) {
  if (!url) return "";
  try {
    const u = new URL(url);
    // shorts
    if (u.hostname.includes("youtube.com") && u.pathname.startsWith("/shorts/")) {
      return u.pathname.split("/")[2] || "";
    }
    // watch?v=
    const vid = u.searchParams.get("v");
    if (vid) return vid;
    // youtu.be/{id}
    if (u.hostname === "youtu.be") {
      return u.pathname.replace("/", "");
    }
    // embed/{id}
    if (u.pathname.includes("/embed/")) {
      return u.pathname.split("/embed/")[1].split("/")[0];
    }
    return "";
  } catch {
    return "";
  }
}

/** Hash simple pour savoir si les donn√©es ont chang√© */
function simpleHash(str) {
  let h = 0, i, chr;
  if (str.length === 0) return h.toString();
  for (i = 0; i < str.length; i++) {
    chr = str.charCodeAt(i);
    h = ((h << 5) - h) + chr;
    h |= 0;
  }
  return h.toString();
}

/** Rendu du feed */
function renderFeed(items) {
  feedEl.innerHTML = "";
  if (!items.length) {
    feedEl.innerHTML = `<p class="hint">Aucune vid√©o trouv√©e (colonne <b>type</b> = "video").</p>`;
    return;
  }

  items.forEach(item => {
    const id = extractYouTubeId(item.url);
    if (!id) return;

    const card = document.createElement("article");
    card.className = "card";
    card.innerHTML = `
      <iframe
        src="https://www.youtube.com/embed/${id}?${YT_PARAMS}"
        allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
      ></iframe>
      <div class="meta">
        <h2 class="title">${item.titre || "Sans titre"}</h2>
        ${item.description ? `<p class="desc">${item.description}</p>` : ""}
      </div>
    `;
    feedEl.appendChild(card);
  });
}

/** Tri par `ordre` si pr√©sent, sinon ordre al√©atoire */
function sortOrShuffle(items) {
  const withOrdre = items.filter(x => Number.isFinite(x.ordre));
  const withoutOrdre = items.filter(x => !Number.isFinite(x.ordre));

  withOrdre.sort((a,b) => a.ordre - b.ordre);

  for (let i = withoutOrdre.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [withoutOrdre[i], withoutOrdre[j]] = [withoutOrdre[j], withoutOrdre[i]];
  }
  return [...withOrdre, ...withoutOrdre];
}

/** Chargement du CSV + rendu */
async function loadAndRender() {
  try {
    statusEl.textContent = "Mise √† jour‚Ä¶";
    // Cache-busting pour √™tre s√ªr de relire la derni√®re version
    const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "_ts=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();

    const hash = simpleHash(text);
    if (hash === lastDataHash && feedEl.children.length) {
      statusEl.textContent = "√Ä jour ‚úîÔ∏é";
      return; // rien n'a chang√©
    }
    lastDataHash = hash;

    const rows = parseCSV(text);
    let data = csvToObjects(rows).map(normalizeRow);

    // On ne garde que les vid√©os
    data = data.filter(x => x.type === "video" && x.url);

    const finalList = sortOrShuffle(data);
    renderFeed(finalList);
    statusEl.textContent = `Charg√© (${finalList.length} vid√©os) ‚úîÔ∏é`;
  } catch (e) {
    console.error(e);
    statusEl.textContent = "Erreur de chargement du CSV üòï";
  }
}

$("#manualRefresh").addEventListener("click", loadAndRender);

loadAndRender();
if (AUTO_REFRESH_MS > 0) {
  setInterval(loadAndRender, AUTO_REFRESH_MS);
}
</script>
</body>
</html>

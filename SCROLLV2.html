<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>SCROLL • productif</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0f1a" />
  <style>
    :root{
      --bg:#0b0f1a; --panel:#1f2937; --panel2:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --brand:#7c3aed; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header,footer{padding:1rem;background:var(--panel2);color:var(--muted)}
    main{padding:1rem;max-width:1100px;margin:auto}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
    .chip{display:flex;align-items:center;gap:.5rem;background:var(--panel);border:1px solid #2b3647;padding:.5rem .7rem;border-radius:999px}
    .feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
    .card{background:var(--panel);border:1px solid #2b3647;border-radius:var(--radius);overflow:hidden}
    .thumb{aspect-ratio:16/9;background:linear-gradient(90deg,#2a3446 25%,#1b2331 37%,#2a3446 63%);background-size:400% 100%;animation:shimmer 2s linear infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .body{padding:.75rem}
    .title{margin:.2rem 0 .4rem;font-size:1rem;line-height:1.3}
    .meta{color:var(--muted);font-size:.85rem}
    .actions{display:flex;gap:.35rem;flex-wrap:wrap;padding:.6rem;border-top:1px dashed #2b3647}
    .btn{flex:1;min-width:90px;padding:.45rem .6rem;border:none;border-radius:9px;background:#2a3446;color:var(--text);cursor:pointer;font-size:.85rem}
    .btn.primary{background:var(--brand);color:#0b0f1a;font-weight:700}
    .btn.ok{background:var(--ok);color:#0b0f1a}
    .btn.warn{background:var(--warn);color:#0b0f1a}
    .btn.danger{background:var(--danger)}
    .badge{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #2b3647;background:#1b2331;color:var(--muted);padding:.2rem .5rem;border-radius:999px;font-size:.75rem}
    .hidden{display:none}
    .toast{position:fixed;bottom:1rem;right:1rem;background:var(--panel2);color:var(--text);padding:.7rem 1rem;border:1px solid #2b3647;border-radius:10px;opacity:0;transition:opacity .25s}
    .toast.show{opacity:1}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:20}
    .modal-inner{background:var(--panel);border:1px solid #2b3647;border-radius:16px;max-width:720px;width:92%;padding:1rem 1.2rem;max-height:84vh;overflow:auto}
    .modal h2{margin:.2rem 0 .6rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.5rem}
    .theme-item{display:flex;gap:.5rem;align-items:center;background:#253044;border:1px solid #2b3647;border-radius:10px;padding:.5rem .6rem}
    .theme-item small{color:var(--muted)}
    .controls-row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.6rem 0}
    .pill{padding:.25rem .5rem;border:1px solid #2b3647;border-radius:999px;background:#192233;color:var(--muted);font-size:.8rem}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}
    .input{appearance:none;background:#192233;border:1px solid #2b3647;color:var(--text);padding:.5rem .6rem;border-radius:9px;min-width:220px}
    .tags{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.4rem}
    .tag{display:inline-flex;align-items:center;gap:.35rem;background:#22304a;border:1px solid #2b3647;color:#cbd5e1;padding:.25rem .5rem;border-radius:999px;font-size:.8rem}
    .tag button{background:transparent;border:none;color:#cbd5e1;cursor:pointer}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
<header>
  <div class="toolbar" role="region" aria-label="Actions rapides">
    <span class="badge">Sans historique</span>
    <button id="openThemeModal" class="btn">Thèmes du jour</button>
    <button id="clearBans" class="btn warn" title="Réinitialiser banlist/whitelist (local)">Reset filtres</button>
    <span id="sessionInfo" class="pill"></span>
  </div>
  <h1>SCROLL • productif</h1>
</header>

<main>
  <section id="feed" class="feed" aria-label="Flux vidéos et fiches"></section>
  <div id="sentinel" aria-hidden="true"></div>
</main>

<footer>
  <small>© 2025 SCROLL – Feed utile, sans historique</small>
</footer>

<!-- Modal de sélection des thèmes + gestion WL/BL/Keywords -->
<div id="themeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="themeTitle">
  <div class="modal-inner">
    <h2 id="themeTitle">Choisis tes thèmes du jour</h2>
    <p class="meta">Ces thèmes servent de <b>mots-clés</b> pour filtrer les vidéos de la session (multi-sélection). Tu peux aussi gérer ta <b>banlist/whitelist</b> et des <b>mots-clés à exclure</b>.</p>

    <h3>Thèmes</h3>
    <div id="themeList" class="grid" role="group" aria-label="Thèmes disponibles"></div>

    <div class="controls-row">
      <label class="pill"><input id="newsFreshOnly" type="checkbox" checked> Fraîcheur pour thèmes d’actualité (&lt; 30 jours)</label>
      <label class="pill"><input id="langFilter" type="checkbox" checked> FR/EN uniquement</label>
      <label class="pill"><input id="minViews" type="checkbox" checked> ≥ 1000 vues</label>
    </div>

    <h3>Filtres avancés</h3>
    <div class="row" style="margin:.4rem 0 .2rem">
      <input id="kwInput" class="input" type="text" placeholder="Ajouter un mot-clé à bloquer (ex: prank, shorts)" />
      <button id="addKw" class="btn">Ajouter mot-clé</button>
    </div>
    <div class="grid">
      <div>
        <strong>Mots-clés bannis</strong>
        <div id="kwTags" class="tags"></div>
      </div>
      <div>
        <strong>Whitelist chaînes</strong>
        <div id="wlChanTags" class="tags"></div>
      </div>
      <div>
        <strong>Whitelist vidéos</strong>
        <div id="wlVidTags" class="tags"></div>
      </div>
      <div>
        <strong>Ban chaînes</strong>
        <div id="banChanTags" class="tags"></div>
      </div>
      <div>
        <strong>Ban vidéos</strong>
        <div id="banVidTags" class="tags"></div>
      </div>
    </div>

    <div class="controls-row">
      <button id="validateThemes" class="btn primary">Valider</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/** =========================
 *  CONFIG / CONSTANTES
 *  ========================= */
const API = "https://script.google.com/macros/s/AKfycbxGsoLaoDhRxfF0m37Qc3D01PU1qIv1s3VPTmNLUP8xSopgOODK9gjQZ57DwlCxLvde2w/exec";
const RATIO = 5;                  // 5 vidéos pour 1 fiche
const PAGE_SIZE = 24;             // cartes par page (infinite scroll)
const FRESH_DAYS = 30;            // actualité: 30 jours (modifié)
const NEWS_HINTS = ["news","actualité","update","urgence","breaking","AI","IA"]; // détecte thèmes "actualité"

/** =========================
 *  ÉTAT / STOCKAGE LOCAL
 *  ========================= */
const store = {
  get: (k,def) => { try { return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(def)); } catch { return def; } },
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
  del: (k) => localStorage.removeItem(k)
};
let whitelistVideos = store.get("whitelistVideos", []);
let whitelistChannels = store.get("whitelistChannels", []);
let banVideos = store.get("banVideos", []);
let banChannels = store.get("banChannels", []);
let favoriteVideos = store.get("favoriteVideos", []);
let favoriteFiches = store.get("favoriteFiches", []);
let blockedKeywords = store.get("blockedKeywords", []); // liste perso de mots à exclure

// État runtime
let RAW = { videos: [], fiches: [], themes: [] };
let SESSION = {
  chosenThemes: [],
  langFilter: true,
  minViews: true,
  newsFreshOnly: true,
  keywords: [],        // mots-clés à partir des thèmes + related
  page: 0,
  mergedFeed: [],      // items fusionnés (après filtres)
  usedVideoIds: new Set()
};

/** =========================
 *  OUTILS
 *  ========================= */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1400);
}

// approx. détection langue FR/EN basée sur titre/chaîne (heuristique simple)
function detectLangish(s=""){
  const str = (s||"").toLowerCase();
  const hasFR = /[àâäçéèêëîïôöùûüœ]/i.test(str) || /\b(le|la|les|des|un|une|et|ou|avec|sans|pour|chez|dans|sur|par)\b/.test(str);
  const hasEN = /\b(the|and|with|without|how to|guide|tips|in|on|for|from)\b/.test(str);
  const nonLatin = /[\u0400-\u04FF\u0600-\u06FF\u0900-\u097F\u4E00-\u9FFF]/.test(str);
  if(nonLatin) return "other";
  if(hasFR && !hasEN) return "fr";
  if(hasEN && !hasFR) return "en";
  if(hasFR && hasEN) return "mixed";
  return "en"; // fallback
}

function isNewsTheme(theme="", related=""){
  const hay = `${theme} ${related}`.toLowerCase();
  return NEWS_HINTS.some(k => hay.includes(k));
}

function isFresh(publishedAt, days=FRESH_DAYS){
  const d = new Date(publishedAt);
  if(Number.isNaN(+d)) return true; // si inconnue, ne bloque pas
  const age = (Date.now() - d.getTime()) / (1000*3600*24);
  return age <= days;
}

function toInt(x){ const n = parseInt(String(x).replace(/\D/g,"") || "0", 10); return Number.isFinite(n)? n : 0; }

function matchKeywords(video, keywords){
  const t = `${video.Titre||""} ${video.channelTitle||""}`.toLowerCase();
  return keywords.length === 0 || keywords.some(k => t.includes(k.toLowerCase()));
}

const $ = sel => document.querySelector(sel);
const feedEl = $("#feed");

/** =========================
 *  CHARGEMENT DES DONNÉES
 *  ========================= */
async function loadAll(){
  const res = await fetch(API, {cache:"no-store"});
  const data = await res.json();
  RAW.videos = Array.isArray(data.videos)? data.videos : [];
  RAW.fiches = Array.isArray(data.fiches)? data.fiches : [];
  RAW.themes = Array.isArray(data.themes)? data.themes : [];
  buildThemeModal();
  renderAllLists();
}

function buildThemeModal(){
  const list = $("#themeList");
  list.innerHTML = "";
  RAW.themes.forEach(th=>{
    const theme = th.Theme ?? th.theme ?? "";
    const related = th.Related ?? th.related ?? "";
    const div = document.createElement("label");
    div.className = "theme-item";
    div.innerHTML = `
      <input type="checkbox" value="${escapeHtml(theme)}" />
      <div>
        <div>${escapeHtml(theme)}</div>
        ${related ? `<small>Related: ${escapeHtml(related)}</small>` : ""}
      </div>
    `;
    list.appendChild(div);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

/** =========================
 *  CONSTRUCTION DU FEED
 *  ========================= */
function startSession(){
  const chosen = [...document.querySelectorAll("#themeList input:checked")].map(i=>i.value);
  if(chosen.length===0){ toast("Choisis au moins un thème"); return; }
  SESSION.chosenThemes = chosen;
  SESSION.langFilter = $("#langFilter").checked;
  SESSION.minViews = $("#minViews").checked;
  SESSION.newsFreshOnly = $("#newsFreshOnly").checked;

  const kws = [];
  RAW.themes.forEach(th=>{
    const t = th.Theme ?? th.theme ?? "";
    const r = (th.Related ?? th.related ?? "");
    if(chosen.includes(t)){
      kws.push(t);
      r.split(/[;,|]/).map(x=>x.trim()).filter(Boolean).forEach(k=>kws.push(k));
    }
  });
  SESSION.keywords = Array.from(new Set(kws.map(s=>s.toLowerCase())));

  $("#sessionInfo").textContent = `Thèmes: ${chosen.join(", ")}`;
  $("#themeModal").classList.add("hidden");

  SESSION.page = 0;
  SESSION.mergedFeed = [];
  SESSION.usedVideoIds = new Set();
  feedEl.innerHTML = "";

  const filteredVideos = applyVideoFilters(RAW.videos, SESSION.keywords);
  const filteredFiches = applyFicheFilters(RAW.fiches, SESSION.keywords);
  SESSION.mergedFeed = mergeFeed(filteredVideos, filteredFiches, RATIO);
  renderNextPage();
}

function applyVideoFilters(videos, keywords){
  const res = [];
  for(const v of videos){
    const id = v.videoId ?? v.videold ?? v.id ?? "";
    const title = v.Titre ?? v.title ?? "";
    const chId = v.channelID ?? v.channelId ?? "";
    const chTitle = v.channelTitle ?? v.channel ?? "";
    const publishedAt = v.publishedAt ?? v.published_at ?? v.date ?? "";
    const views = toInt(v.viewCount ?? v.views ?? 0);

    if(banVideos.includes(id) || banChannels.includes(chId)) continue;
    if(blockedKeywords.length){
      const t = `${title} ${chTitle}`.toLowerCase();
      if(blockedKeywords.some(k=>t.includes(k.toLowerCase()))) continue;
    }

    if(SESSION.langFilter){
      const lang = detectLangish(`${title} ${chTitle}`);
      if(!(lang==="fr" || lang==="en" || lang==="mixed")) continue;
    }

    if(SESSION.minViews && views < 1000){
      if(!(whitelistVideos.includes(id) || whitelistChannels.includes(chId))) continue;
    }

    if(!matchKeywords({Titre:title, channelTitle:chTitle}, keywords)){
      if(!(whitelistVideos.includes(id) || whitelistChannels.includes(chId))) continue;
    }

    if(SESSION.newsFreshOnly){
      const newsChosen = RAW.themes.some(th => SESSION.chosenThemes.includes(th.Theme ?? th.theme ?? "") && isNewsTheme(th.Theme, th.Related));
      if(newsChosen && !isFresh(publishedAt, FRESH_DAYS)){
        if(!(whitelistVideos.includes(id) || whitelistChannels.includes(chId))) continue;
      }
    }

    if(SESSION.usedVideoIds.has(id)) continue;
    SESSION.usedVideoIds.add(id);

    res.push({
      type:"video",
      id, title, chId, chTitle, publishedAt, views,
      url: v.url,
      thumb: v.thumbnail ?? `https://i.ytimg.com/vi/${id}/hqdefault.jpg`
    });
  }
  return res;
}

function applyFicheFilters(fiches, keywords){
  const res = [];
  for(const f of fiches){
    const title = f.Titre ?? "";
    const matiere = f.Matière ?? f.Matiere ?? "";
    const embed = f.Embed ?? f.embed ?? f.Url ?? f.URL ?? "";
    if(!embed) continue;
    const t = `${title} ${matiere}`.toLowerCase();
    if(keywords.length === 0 || keywords.some(k=>t.includes(k.toLowerCase()))){
      res.push({ type:"fiche", title, matiere, embed });
    }
  }
  return res;
}

function mergeFeed(videos, fiches, ratio){
  const merged = [];
  let fi = 0;
  for(let i=0;i<videos.length;i++){
    merged.push(videos[i]);
    if((i+1) % ratio === 0 && fi < fiches.length){
      merged.push(fiches[fi++]);
    }
  }
  return merged;
}

/** =========================
 *  RENDU / UI
 *  ========================= */
function renderNextPage(){
  const start = SESSION.page * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const batch = SESSION.mergedFeed.slice(start, end);
  if(batch.length === 0) return;

  const frag = document.createDocumentFragment();
  for(const item of batch){
    if(item.type === "video") frag.appendChild(renderVideoCard(item));
    else frag.appendChild(renderFicheCard(item));
  }
  feedEl.appendChild(frag);
  SESSION.page++;
}

function renderVideoCard(v){
  const a = document.createElement("article");
  a.className = "card";
  const fav = favoriteVideos.includes(v.id);
  const wv = whitelistVideos.includes(v.id), wc = whitelistChannels.includes(v.chId);
  const bv = banVideos.includes(v.id), bc = banChannels.includes(v.chId);

  a.innerHTML = `
    <div class="thumb" role="img" aria-label="Aperçu vidéo"></div>
    <div class="body">
      <div class="title">${escapeHtml(v.title)}</div>
      <div class="meta">${escapeHtml(v.chTitle)} · ${v.views.toLocaleString("fr-FR")} vues · ${formatDate(v.publishedAt)}</div>
    </div>
    <div class="actions">
      <a class="btn primary" href="${v.url}" target="_blank" rel="noopener">Ouvrir YouTube</a>
      <button class="btn ${fav?'ok':''}" data-action="fav-video" data-id="${v.id}">${fav?'★ Favori':'☆ Favori'}</button>
      <button class="btn ${wv?'ok':''}" data-action="whitelist-video" data-id="${v.id}">${wv?'✓ WL vidéo':'WL vidéo'}</button>
      <button class="btn ${wc?'ok':''}" data-action="whitelist-channel" data-id="${v.chId}">${wc?'✓ WL chaîne':'WL chaîne'}</button>
      <button class="btn ${bv||bc?'danger':''}" data-action="ban-video" data-id="${v.id}">${(bv||bc)?'Banni':'Ban vidéo'}</button>
      <button class="btn ${bc?'danger':''}" data-action="ban-channel" data-id="${v.chId}">${bc?'Chaîne bannie':'Ban chaîne'}</button>
    </div>
  `;
  return a;
}

function renderFicheCard(f){
  const a = document.createElement("article");
  a.className = "card";
  const fav = favoriteFiches.includes(f.embed);
  a.innerHTML = `
    <div class="thumb" role="img" aria-label="Aperçu fiche"></div>
    <div class="body">
      <div class="title">${escapeHtml(f.title)}</div>
      <div class="meta">Fiche · ${escapeHtml(f.matiere||"")}</div>
    </div>
    <div class="actions">
      <a class="btn primary" href="${f.embed}" target="_blank" rel="noopener">Ouvrir la fiche</a>
      <button class="btn ${fav?'ok':''}" data-action="fav-fiche" data-id="${f.embed}">${fav?'★ Favori':'☆ Favori'}</button>
    </div>
  `;
  return a;
}

function formatDate(d){
  const dt = new Date(d);
  if(Number.isNaN(+dt)) return "";
  return dt.toLocaleDateString("fr-FR", {year:"numeric", month:"short", day:"2-digit"});
}

/** =========================
 *  ACTIONS BOUTONS (cartes)
 *  ========================= */
document.addEventListener("click", (e)=>{
  const btn = e.target.closest("button, a");
  if(!btn) return;
  const action = btn.dataset.action;
  if(!action) return;
  const id = btn.dataset.id;

  switch(action){
    case "fav-video":
      toggleInArray("favoriteVideos", favoriteVideos, id);
      btn.classList.toggle("ok");
      btn.textContent = favoriteVideos.includes(id) ? "★ Favori" : "☆ Favori";
      toast(favoriteVideos.includes(id)?"Ajouté aux favoris":"Retiré des favoris");
      break;

    case "fav-fiche":
      toggleInArray("favoriteFiches", favoriteFiches, id);
      btn.classList.toggle("ok");
      btn.textContent = favoriteFiches.includes(id) ? "★ Favori" : "☆ Favori";
      toast(favoriteFiches.includes(id)?"Fiche en favoris":"Fiche retirée");
      break;

    case "whitelist-video":
      toggleInArray("whitelistVideos", whitelistVideos, id);
      btn.classList.toggle("ok");
      btn.textContent = whitelistVideos.includes(id) ? "✓ WL vidéo" : "WL vidéo";
      renderAllLists();
      refreshAfterListChange();
      toast(whitelistVideos.includes(id)?"Vidéo whitelisted":"Whitelist vidéo retirée");
      break;

    case "whitelist-channel":
      toggleInArray("whitelistChannels", whitelistChannels, id);
      btn.classList.toggle("ok");
      btn.textContent = whitelistChannels.includes(id) ? "✓ WL chaîne" : "WL chaîne";
      renderAllLists();
      refreshAfterListChange();
      toast(whitelistChannels.includes(id)?"Chaîne whitelisted":"Whitelist chaîne retirée");
      break;

    case "ban-video":
      toggleInArray("banVideos", banVideos, id);
      btn.classList.toggle("danger");
      btn.textContent = (banVideos.includes(id)) ? "Banni" : "Ban vidéo";
      renderAllLists();
      refreshAfterListChange();
      toast(banVideos.includes(id)?"Vidéo bannie":"Vidéo débannie");
      break;

    case "ban-channel":
      toggleInArray("banChannels", banChannels, id);
      btn.classList.toggle("danger");
      btn.textContent = banChannels.includes(id) ? "Chaîne bannie" : "Ban chaîne";
      renderAllLists();
      refreshAfterListChange();
      toast(banChannels.includes(id)?"Chaîne bannie":"Chaîne débannie");
      break;

    case "remove-tag":
      removeFromList(btn.dataset.list, btn.dataset.value);
      renderAllLists();
      refreshAfterListChange();
      break;
  }
});

function toggleInArray(key, arr, id){
  const i = arr.indexOf(id);
  if(i>=0) arr.splice(i,1); else arr.push(id);
  store.set(key, arr);
}

function removeFromList(listName, value){
  const map = {
    "whitelistVideos": [whitelistVideos, "whitelistVideos"],
    "whitelistChannels": [whitelistChannels, "whitelistChannels"],
    "banVideos": [banVideos, "banVideos"],
    "banChannels": [banChannels, "banChannels"],
    "blockedKeywords": [blockedKeywords, "blockedKeywords"],
  };
  const pair = map[listName];
  if(!pair) return;
  const [arr, key] = pair;
  const i = arr.indexOf(value);
  if(i>=0) arr.splice(i,1);
  store.set(key, arr);
}

function refreshAfterListChange(){
  if(SESSION.chosenThemes.length===0) return; // pas encore démarré
  SESSION.page = 0;
  SESSION.mergedFeed = [];
  SESSION.usedVideoIds = new Set();
  feedEl.innerHTML = "";
  const filteredVideos = applyVideoFilters(RAW.videos, SESSION.keywords);
  const filteredFiches = applyFicheFilters(RAW.fiches, SESSION.keywords);
  SESSION.mergedFeed = mergeFeed(filteredVideos, filteredFiches, RATIO);
  renderNextPage();
}

// reset filtres
$("#clearBans").addEventListener("click", ()=>{
  whitelistVideos = []; whitelistChannels = []; banVideos = []; banChannels = []; blockedKeywords = [];
  store.set("whitelistVideos", whitelistVideos);
  store.set("whitelistChannels", whitelistChannels);
  store.set("banVideos", banVideos);
  store.set("banChannels", banChannels);
  store.set("blockedKeywords", blockedKeywords);
  renderAllLists();
  refreshAfterListChange();
  toast("Filtres réinitialisés");
});

// ouvrir modale manuellement
$("#openThemeModal").addEventListener("click", ()=> { renderAllLists(); $("#themeModal").classList.remove("hidden") });

// valider modale
$("#validateThemes").addEventListener("click", startSession);

// Ajout mot-clé bloqué
$("#addKw").addEventListener("click", ()=>{
  const inp = $("#kwInput");
  const val = (inp.value||"").trim();
  if(!val) return;
  if(!blockedKeywords.includes(val)){
    blockedKeywords.push(val);
    store.set("blockedKeywords", blockedKeywords);
    renderAllLists();
    refreshAfterListChange();
    toast(`Mot-clé bloqué: ${val}`);
  }
  inp.value = "";
});

$("#kwInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); $("#addKw").click(); }
});

// rendu des listes (tags)
function renderAllLists(){
  renderTagList("#kwTags", blockedKeywords, x=>x, "blockedKeywords");
  renderTagList("#wlChanTags", whitelistChannels, x=>x, "whitelistChannels");
  renderTagList("#wlVidTags", whitelistVideos, x=>x, "whitelistVideos");
  renderTagList("#banChanTags", banChannels, x=>x, "banChannels");
  renderTagList("#banVidTags", banVideos, x=>x, "banVideos");
}

function renderTagList(selector, arr, labelFn, listName){
  const el = document.querySelector(selector);
  if(!el) return;
  el.innerHTML = "";
  arr.forEach(val=>{
    const tag = document.createElement("span");
    tag.className = "tag";
    tag.innerHTML = `${escapeHtml(labelFn(val))} <button aria-label="Retirer" data-action="remove-tag" data-list="${listName}" data-value="${escapeHtml(val)}">✕</button>`;
    el.appendChild(tag);
  });
}

/** =========================
 *  INFINITE SCROLL
 *  ========================= */
new IntersectionObserver(entries=>{
  if(entries[0].isIntersecting) renderNextPage();
}, {rootMargin:"600px"}).observe(document.getElementById("sentinel"));

/** =========================
 *  DÉMARRAGE
 *  ========================= */
loadAll().catch(()=>toast("Erreur de chargement des données"));

</script>
</body>
</html>
